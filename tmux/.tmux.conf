# ───────────────────────────────────────────────────────
# Core Settings
# ───────────────────────────────────────────────────────
set -sg escape-time 50                     # remove escape‐time glitches
set -g mouse on                            # enable mouse support

# Start windows & panes at 1
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set -g renumber-windows on

# True color & focus events
set -sa terminal-overrides ',xterm*:Tc'
set -g focus-events on


# ───────────────────────────────────────────────────────
# Prefix Key
# ───────────────────────────────────────────────────────
unbind C-b
set -g prefix C-a
bind C-a send-prefix


# ───────────────────────────────────────────────────────
# Prefix-Highlight Plugin Configuration
# ───────────────────────────────────────────────────────
set -g @prefix_highlight_prefix_prompt '󰌌'
set -g @prefix_highlight_bg           'default'
set -g @prefix_highlight_output_prefix ''
set -g @prefix_highlight_output_suffix '  '


# ───────────────────────────────────────────────────────
# Matugen colours (fallbacks + override)
# ───────────────────────────────────────────────────────
# These are fallbacks so your config still works before matugen runs.
# Matugen will overwrite these options by sourcing ~/.cache/matugen/tmux.conf.
set -g @pill_edge_l "fg=#2b4a30,bg=default"
set -g @pill_l      "fg=#b4befe,bg=#2b4a30"

set -g @pill_edge_r "fg=#2b2a30,bg=default"
set -g @pill_r      "fg=#b4befe,bg=#2b2a30"

set -g @muted       "fg=#45475a,bg=default"

# Load matugen-generated theme if present (overrides the fallbacks above)
if-shell 'test -f ~/.cache/matugen/tmux.conf' "source-file ~/.cache/matugen/tmux.conf"


# ───────────────────────────────────────────────────────
# Status Bar (must come before TPM loads)
# ───────────────────────────────────────────────────────
set -g status-interval  10
set -g status-justify   left
set -g status-position  bottom
set -g status-style     bg=default

# LEFT: dynamic prefix flash + session name
set -g status-left "#[#{@pill_edge_l}]\
#[#{@pill_l}]  #S \
#[#{@pill_edge_l}]\
#[#{@muted}] | "

# ───────────────────────────────────────────────────────
# RIGHT: weather | time | date (pill-shaped segments)
# ───────────────────────────────────────────────────────
set -g status-right-length 200
set -g status-right "#{prefix_highlight}\
#[#{@pill_edge_r}]\
#[#{@pill_r}] #(curl -s 'wttr.in/Norwich?format=3') \
#[#{@pill_edge_r}]  \
#[#{@pill_edge_r}]\
#[#{@pill_r}]  %H:%M \
#[#{@pill_edge_r}]  \
#[#{@pill_edge_r}]\
#[#{@pill_r}]  %d/%m/%y \
#[#{@pill_edge_r}]"


# ───────────────────────────────────────────────────────
# Plugin Definitions & TPM Initialization
# ───────────────────────────────────────────────────────
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
run '~/.tmux/plugins/tpm/tpm'


# ───────────────────────────────────────────────────────
# Reload & Splits
# ───────────────────────────────────────────────────────
unbind r
bind r source-file ~/.tmux.conf \; display-message "✔ Reloaded!"

bind | split-window -h -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"
bind c new-window      -c "#{pane_current_path}"


# ───────────────────────────────────────────────────────
# Vim-Style Copy Mode
# ───────────────────────────────────────────────────────
set-window-option -g mode-keys vi
bind-key -T copy-mode-vi v   send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y   send-keys -X copy-selection-and-cancel


# ───────────────────────────────────────────────────────
# Window & Pane Formats
# ───────────────────────────────────────────────────────
set -g window-status-format         '#[fg=gray,bg=default]  #I #W '
set -g window-status-current-format '#[#{@pill_edge_r}] #[#{@pill_r}]#I #W#[#{@pill_edge_r}]'
set -g window-status-last-style     fg=white,bg=default


# ───────────────────────────────────────────────────────
# Borders & Messages
# ───────────────────────────────────────────────────────
# Keep your existing logic; matugen will override these via ~/.cache/matugen/tmux.conf
set -g pane-border-style        fg=#b4befe
set -g pane-active-border-style fg=#b4befe
set -g message-style            bg=default,fg=#f4dcdc
set -g message-command-style    bg=default,fg=#f2dcdc
set -g mode-style               bg=default,fg=#f2dcdc

set -g @continuum-restore 'on'
set -g @continuum-auto-save 'on'
set -g @continuum-save-interval '5'
set -g @continuum-boot 'on'

set -g default-terminal "tmux-256color"
